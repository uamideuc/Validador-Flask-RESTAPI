# üõ°Ô∏è Validador de Instrumentos - Gu√≠a T√©cnica Completa
## Versi√≥n 2.0 - Sistema Seguro y Listo para Producci√≥n

## üìã √çndice
1. [Estado Actual - Versi√≥n 2.0](#estado-actual---versi√≥n-20)
2. [Arquitectura de Seguridad](#arquitectura-de-seguridad)  
3. [Sistema de Autenticaci√≥n](#sistema-de-autenticaci√≥n)
4. [Flujo de Trabajo Seguro](#flujo-de-trabajo-seguro)
5. [Backend Seguro - Flask](#backend-seguro---flask)
6. [Frontend con Autenticaci√≥n - React](#frontend-con-autenticaci√≥n---react)
7. [Base de Datos con Aislamiento](#base-de-datos-con-aislamiento)
8. [APIs Protegidas](#apis-protegidas)
9. [Configuraci√≥n de Seguridad](#configuraci√≥n-de-seguridad)
10. [C√≥mo Hacer Cambios Seguros](#c√≥mo-hacer-cambios-seguros)
11. [Deployment y Producci√≥n](#deployment-y-producci√≥n)
12. [Troubleshooting](#troubleshooting)

---

## üîÑ Estado Actual - Versi√≥n 2.0

### üéâ TRANSFORMACI√ìN COMPLETA DE SEGURIDAD

**DE**: ‚ùå Aplicaci√≥n sin seguridad, vulnerable a acceso no autorizado  
**A**: ‚úÖ **Sistema empresarial seguro con autenticaci√≥n institucional**

### ‚ú® Funcionalidades Implementadas

#### üîê **Seguridad (NUEVA - Completa)**
1. **Sistema de Login Institucional**
   - Pantalla de login profesional en espa√±ol
   - Autenticaci√≥n con clave institucional compartida
   - Interfaz Material-UI elegante y responsive

2. **Gesti√≥n de Sesiones JWT**
   - Tokens JWT seguros con expiraci√≥n de 24 horas
   - Renovaci√≥n autom√°tica de tokens
   - Invalidaci√≥n segura al logout

3. **Aislamiento de Datos por Usuario**
   - Cada sesi√≥n tiene sus propios datos
   - Imposibilidad de acceder a datos de otros usuarios
   - Validaci√≥n estricta de propiedad de recursos

4. **Seguridad de Archivos**
   - Escaneo de seguridad en uploads
   - Validaci√≥n MIME con python-magic (con fallback)
   - Detecci√≥n de macros en archivos Excel
   - Almacenamiento temporal seguro

5. **Limpieza Autom√°tica**
   - Eliminaci√≥n programada de archivos expirados
   - Limpieza de sesiones caducadas (24 horas)
   - Gesti√≥n autom√°tica del ciclo de vida de datos

6. **Protecci√≥n de Infraestructura**
   - Headers de seguridad HTTP comprehensivos
   - Protecci√≥n CORS espec√≠fica por entorno
   - Validaci√≥n de configuraci√≥n de producci√≥n
   - Detecci√≥n y filtrado de requests maliciosas

#### ‚úÖ **Core Features (Actualizadas con Seguridad)**
1. **Carga de Archivos Segura**
   - Validaci√≥n de seguridad antes del procesamiento
   - Soporte para Excel (.xlsx, .xls) y CSV con escaneo
   - Selecci√≥n de hojas en Excel con validaci√≥n
   - Manejo seguro de diferentes encodings

2. **Preview de Datos Protegido**
   - Visualizaci√≥n paginada con aislamiento de sesi√≥n
   - Navegaci√≥n por p√°ginas (10 filas por defecto)
   - Detecci√≥n autom√°tica de columnas sin nombre
   - Alertas de seguridad para contenido sospechoso

3. **Categorizaci√≥n de Variables con Sesi√≥n**
   - Drag & drop protegido por autenticaci√≥n
   - Vista previa de valores con validaci√≥n
   - Almacenamiento seguro de categorizaci√≥n

4. **Validaciones de Datos Aisladas**
   - Validaciones ejecutadas solo en datos del usuario
   - Detecci√≥n de duplicados por instrumento
   - Validaci√≥n de completitud de metadata
   - An√°lisis de variables de clasificaci√≥n

5. **Exportaciones Seguras**
   - Exportaciones protegidas por JWT
   - Datos normalizados con validaci√≥n de propiedad
   - Reportes PDF con marca de agua de seguridad
   - Descargas autenticadas y trazables

### üõ°Ô∏è **Caracter√≠sticas de Seguridad Detalladas**

#### **Autenticaci√≥n Institucional**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   PANTALLA DE LOGIN         ‚îÇ
‚îÇ                             ‚îÇ
‚îÇ üîë Clave Institucional      ‚îÇ
‚îÇ [____________________]      ‚îÇ
‚îÇ                             ‚îÇ
‚îÇ [üëÅÔ∏è] Mostrar clave         ‚îÇ
‚îÇ                             ‚îÇ
‚îÇ     [Ingresar al Sistema]   ‚îÇ
‚îÇ                             ‚îÇ
‚îÇ üí° Informaci√≥n de seguridad ‚îÇ
‚îÇ üõ°Ô∏è Protecci√≥n de datos     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### **Flujo de Seguridad**
```
Usuario ingresa clave ‚Üí Validaci√≥n backend ‚Üí JWT generado ‚Üí 
Sesi√≥n creada ‚Üí Acceso a aplicaci√≥n ‚Üí Datos aislados ‚Üí 
Auto-logout (24h) ‚Üí Limpieza autom√°tica
```

#### **Aislamiento de Datos**
```
Usuario A (Sesi√≥n: sess_abc123)
‚îú‚îÄ‚îÄ Archivos: solo_del_usuario_A.xlsx
‚îú‚îÄ‚îÄ Validaciones: solo_resultados_A
‚îî‚îÄ‚îÄ Exportaciones: solo_exports_A

Usuario B (Sesi√≥n: sess_xyz789)  
‚îú‚îÄ‚îÄ Archivos: solo_del_usuario_B.csv
‚îú‚îÄ‚îÄ Validaciones: solo_resultados_B
‚îî‚îÄ‚îÄ Exportaciones: solo_exports_B

‚ùå Usuario A NO puede ver datos de Usuario B
‚ùå Usuario B NO puede ver datos de Usuario A
```

### üìä **M√©tricas de la Aplicaci√≥n Segura**

- **L√≠neas de c√≥digo:** ~5,500 (backend) + ~3,200 (frontend)
- **M√≥dulos de seguridad:** 8 nuevos archivos de seguridad
- **Endpoints protegidos:** 15 endpoints con JWT
- **Tests de seguridad:** 25+ tests actualizados
- **Configuraciones:** Scripts de setup autom√°tico
- **Headers de seguridad:** 8 headers HTTP implementados
- **Tiempo de sesi√≥n:** 24 horas con renovaci√≥n autom√°tica

### üöÄ **Estado de Funcionalidades - VERSI√ìN 2.0**

| Funcionalidad | Estado | Notas de Seguridad |
|---------------|--------|--------------------|
| **Autenticaci√≥n** | ‚úÖ **Completa** | Login institucional, JWT, sesiones |
| **Autorizaci√≥n** | ‚úÖ **Completa** | Aislamiento de datos, propiedad de recursos |
| **Carga de archivos** | ‚úÖ **Segura** | Escaneo de seguridad, validaci√≥n MIME |
| **Preview de datos** | ‚úÖ **Protegido** | Datos aislados por sesi√≥n |
| **Categorizaci√≥n** | ‚úÖ **Autenticado** | Almacenamiento seguro de categorizaci√≥n |
| **Validaciones** | ‚úÖ **Aisladas** | Solo datos del usuario autenticado |
| **Exportaciones** | ‚úÖ **Protegidas** | JWT requerido, descargas trazables |
| **Limpieza autom√°tica** | ‚úÖ **Activa** | Scheduler de limpieza cada hora |
| **Testing seguridad** | ‚úÖ **Validado** | Tests de autenticaci√≥n y autorizaci√≥n |
| **Configuraci√≥n prod** | ‚úÖ **Lista** | Scripts de setup para producci√≥n |

---

## üèõÔ∏è Arquitectura de Seguridad

### Patr√≥n: Autenticaci√≥n + Autorizaci√≥n + Aislamiento

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    HTTPS/JWT     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   FRONTEND      ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ ‚îÇ    BACKEND      ‚îÇ
‚îÇ React + Auth    ‚îÇ   Autenticado    ‚îÇ Flask + JWT     ‚îÇ
‚îÇ Context + UI    ‚îÇ                  ‚îÇ + Decoradores   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                             ‚îÇ
                                             ‚ñº
                                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                  ‚îÇ   BASE DE DATOS     ‚îÇ
                                  ‚îÇ SQLite + Aislamiento‚îÇ
                                  ‚îÇ  session_id en      ‚îÇ
                                  ‚îÇ  todas las tablas   ‚îÇ
                                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### ¬øPor qu√© esta arquitectura de seguridad?

1. **Defensa en Profundidad**: M√∫ltiples capas de protecci√≥n
2. **Principio de Menor Privilegio**: Usuarios solo acceden a sus datos
3. **Separaci√≥n de Responsabilidades**: Autenticaci√≥n vs Autorizaci√≥n
4. **Escalabilidad Segura**: Preparado para m√∫ltiples usuarios
5. **Auditabilidad**: Todas las acciones son trazables

---

## üîê Sistema de Autenticaci√≥n

### Modelo de Autenticaci√≥n Institucional

#### ¬øQu√© es la Autenticaci√≥n Institucional?
- **Una clave compartida** por toda la organizaci√≥n
- **M√∫ltiples usuarios** usando la misma clave
- **Sesiones individuales** una vez autenticados
- **Datos completamente separados** entre usuarios

#### Flujo de Autenticaci√≥n Detallado

```typescript
// 1. Usuario ingresa clave en Login.tsx
const login = async (accessKey: string) => {
  // 2. Llamada al backend
  const response = await fetch('/api/auth/institutional-login', {
    method: 'POST',
    body: JSON.stringify({ access_key: accessKey })
  });
  
  // 3. Backend valida clave y genera JWT
  if (response.ok) {
    const { access_token, session_id } = await response.json();
    
    // 4. Frontend almacena tokens
    localStorage.setItem('accessToken', access_token);
    localStorage.setItem('sessionId', session_id);
    
    // 5. AuthContext actualiza estado
    setAuthState({ isAuthenticated: true, ... });
  }
};
```

#### Gesti√≥n de Tokens JWT

**Caracter√≠sticas:**
- **Expiraci√≥n**: 24 horas autom√°ticamente
- **Renovaci√≥n**: Transparente en cada request
- **Invalidaci√≥n**: Logout inmediato
- **Almacenamiento**: localStorage con limpieza autom√°tica

**Interceptor Autom√°tico (api.ts):**
```typescript
axios.interceptors.request.use((config) => {
  const token = localStorage.getItem('accessToken');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

axios.interceptors.response.use(
  response => response,
  error => {
    if (error.response?.status === 401) {
      // Token expirado - logout autom√°tico
      localStorage.removeItem('accessToken');
      window.location.reload();
    }
  }
);
```

### Componente Login Profesional

#### Caracter√≠sticas del Login:
- **Dise√±o Material-UI** con estilo corporativo
- **Campos de validaci√≥n** con feedback en tiempo real
- **Toggle de visibilidad** para la clave institucional
- **Mensajes en espa√±ol** amigables para el usuario
- **Loading states** con spinners durante autenticaci√≥n
- **Informaci√≥n de seguridad** para usuarios finales

#### Estructura Visual:
```
üéì VALIDADOR DE INSTRUMENTOS
   Sistema de Validaci√≥n de Instrumentos Educativos

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üîí ACCESO INSTITUCIONAL                     ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ Clave Institucional                         ‚îÇ
‚îÇ [________________________________] [üëÅÔ∏è]    ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ         [Ingresar al Sistema]               ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ ‚ÑπÔ∏è  INFORMACI√ìN                            ‚îÇ
‚îÇ La clave la proporciona su administrador   ‚îÇ
‚îÇ Su sesi√≥n expira en 24 horas               ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ üõ°Ô∏è SEGURIDAD                              ‚îÇ
‚îÇ Datos protegidos con cifrado               ‚îÇ
‚îÇ Cada sesi√≥n es √∫nica e independiente       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîÑ Flujo de Trabajo Seguro

### Flujo Completo con Seguridad

```
0. AUTENTICACI√ìN (NUEVO)
   Frontend: Login.tsx ‚Üí AuthContext ‚Üí ApiService.login()
   Backend: /api/auth/institutional-login ‚Üí SessionManager
   Resultado: JWT token, session_id √∫nico

1. SUBIDA DE ARCHIVO SEGURA
   Frontend: FileUpload ‚Üí ApiService.uploadFile() (con JWT)
   Backend: /api/files/upload + @jwt_required + security_scan
   Resultado: upload_id vinculado a session_id

2. PARSING PROTEGIDO
   Frontend: ApiService.parseFile(upload_id) (con JWT)
   Backend: /api/files/{id}/parse + @require_session_ownership
   Resultado: Solo si el archivo pertenece al usuario

3. PREVIEW AISLADO
   Frontend: DataPreview ‚Üí ApiService.getDataPreview() (con JWT)
   Backend: /api/files/{id}/preview + @require_session_ownership
   Resultado: Preview solo de datos propios

4. CATEGORIZACI√ìN AUTENTICADA
   Frontend: VariableCategorization ‚Üí ApiService.saveCategorization()
   Backend: /api/files/{id}/categorization + @require_session_ownership
   Resultado: validation_session_id vinculado a user session

5. VALIDACI√ìN AISLADA
   Frontend: ApiService.runValidation(session_id) (con JWT)
   Backend: /api/validation/run + @jwt_required + ownership validation
   Resultado: validation_report solo de datos del usuario

6. EXPORTACI√ìN PROTEGIDA
   Frontend: ApiService.exportXXX() (con JWT)
   Backend: /api/export/* + @jwt_required + ownership validation
   Resultado: Solo exportaciones de datos propios

7. LIMPIEZA AUTOM√ÅTICA (EN BACKGROUND)
   Backend: cleanup_scheduler.py
   Resultado: Archivos y sesiones > 24h eliminados autom√°ticamente
```

### Estados de Seguridad

#### Estado No Autenticado
```typescript
// AuthContext state
{
  isAuthenticated: false,
  accessToken: null,
  sessionId: null,
  isLoading: false
}

// UI mostrada
<Login /> // Pantalla de login institucional
```

#### Estado Autenticado
```typescript
// AuthContext state  
{
  isAuthenticated: true,
  accessToken: "eyJhbGciOiJIUzI1NiIs...",
  sessionId: "sess_9Fk8YaK0fOHSBmu2h6Hu...",
  isLoading: false
}

// UI mostrada
<AppContent /> // Aplicaci√≥n principal con datos del usuario
```

#### Estado de Carga
```typescript
// Mientras valida token almacenado
{
  isAuthenticated: false,
  accessToken: null,
  sessionId: null,
  isLoading: true // üîÑ Spinner de carga
}
```

---

## üêç Backend Seguro - Flask

### Estructura con M√≥dulos de Seguridad

```
backend/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py              # Factory con validaci√≥n de seguridad
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ data_models.py       # Modelos de datos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.py          # DB con aislamiento de sesiones
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ session_model.py     # üîê Gesti√≥n de sesiones JWT
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.py              # üîê Endpoints de autenticaci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ files.py             # Endpoints protegidos de archivos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validation.py        # Endpoints protegidos de validaci√≥n
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ export.py            # Endpoints protegidos de exportaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ file_service.py      # Procesamiento con validaci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ file_security.py     # üîê Validaci√≥n de seguridad de archivos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validation_engine.py # Motor de validaciones
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ data_normalizer.py   # Normalizaci√≥n segura
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pdf_generator.py     # Generaci√≥n de PDFs
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ session_auth.py      # üîê Decoradores de autorizaci√≥n
‚îÇ       ‚îî‚îÄ‚îÄ cleanup_scheduler.py # üîê Limpieza autom√°tica
‚îú‚îÄ‚îÄ setup_development.ps1        # üîê Setup de desarrollo seguro
‚îú‚îÄ‚îÄ setup_production.ps1         # üîê Setup de producci√≥n
‚îú‚îÄ‚îÄ .env                         # üîê Variables de entorno secretas
‚îî‚îÄ‚îÄ requirements.txt             # Dependencias + librer√≠as de seguridad
```

### Nuevos Patrones de Seguridad

#### 1. Decoradores de Autenticaci√≥n y Autorizaci√≥n
```python
from flask_jwt_extended import jwt_required, get_jwt_identity
from app.utils.session_auth import require_session_ownership

@bp.route('/<int:upload_id>/parse', methods=['POST'])
@jwt_required()                           # ‚úÖ Requiere JWT v√°lido
@require_session_ownership('upload')      # ‚úÖ Valida propiedad del recurso
def parse_file(upload_id):
    # Solo se ejecuta si:
    # 1. JWT es v√°lido y no ha expirado
    # 2. El upload_id pertenece al usuario actual
    pass
```

#### 2. Aislamiento de Base de Datos
```python
# Antes (SIN SEGURIDAD)
def create_upload_record(self, filename, file_path):
    # ‚ùå Todos los usuarios ven todos los archivos
    cursor.execute("INSERT INTO uploads (filename, file_path) VALUES (?, ?)", 
                   (filename, file_path))

# Ahora (CON SEGURIDAD)  
def create_upload_record(self, session_id, filename, file_path):
    # ‚úÖ Cada upload vinculado a una sesi√≥n espec√≠fica
    cursor.execute("""
        INSERT INTO uploads (session_id, filename, file_path, expires_at) 
        VALUES (?, ?, ?, ?)
    """, (session_id, filename, file_path, expires_at))
```

#### 3. Validaci√≥n de Configuraci√≥n de Seguridad
```python
def validate_production_config():
    """Valida configuraci√≥n antes de iniciar"""
    flask_env = os.environ.get('FLASK_ENV')
    
    if flask_env == 'production':
        secret_key = os.environ.get('SECRET_KEY', '')
        
        # ‚úÖ Evita claves de desarrollo en producci√≥n
        if secret_key in ['dev-secret-key']:
            raise ValueError("USANDO CLAVE DE DESARROLLO EN PRODUCCI√ìN!")
        
        # ‚úÖ Valida longitud m√≠nima de clave
        if len(secret_key) < 32:
            raise ValueError("SECRET_KEY debe tener al menos 32 caracteres")
```

#### 4. Headers de Seguridad Autom√°ticos
```python
@app.after_request
def add_security_headers(response):
    # Previene MIME sniffing
    response.headers['X-Content-Type-Options'] = 'nosniff'
    
    # Previene clickjacking
    response.headers['X-Frame-Options'] = 'DENY'
    
    # Protecci√≥n XSS
    response.headers['X-XSS-Protection'] = '1; mode=block'
    
    if flask_env == 'production':
        # HTTPS obligatorio en producci√≥n
        response.headers['Strict-Transport-Security'] = 'max-age=31536000'
        
        # Content Security Policy
        response.headers['Content-Security-Policy'] = (
            "default-src 'self'; "
            "script-src 'self' 'unsafe-inline'; "
            "style-src 'self' 'unsafe-inline'"
        )
    
    return response
```

### Gesti√≥n de Sesiones (session_model.py)

#### Caracter√≠sticas del SessionManager:
- **Generaci√≥n segura de IDs** con `secrets.token_urlsafe(32)`
- **Validaci√≥n de claves institucionales** contra variable de entorno
- **Seguimiento de IP y User-Agent** para auditabil√≠a
- **Limpieza autom√°tica** de sesiones expiradas
- **Validaci√≥n de duraci√≥n** configurable (24h por defecto)

```python
class SessionManager:
    def create_session(self, client_ip: str, user_agent: str) -> str:
        """Crea una nueva sesi√≥n autenticada"""
        session_id = f"sess_{secrets.token_urlsafe(32)}"
        expires_at = datetime.utcnow() + timedelta(hours=24)
        
        # Almacena informaci√≥n de sesi√≥n
        self._store_session(session_id, client_ip, user_agent, expires_at)
        
        return session_id
    
    def validate_session(self, session_id: str) -> bool:
        """Valida que la sesi√≥n siga activa"""
        session = self._get_session(session_id)
        return session and session['expires_at'] > datetime.utcnow()
```

---

## ‚öõÔ∏è Frontend con Autenticaci√≥n - React

### Estructura con Autenticaci√≥n

```
frontend/src/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ Login.tsx                # üîê Pantalla de login institucional
‚îÇ   ‚îú‚îÄ‚îÄ FileUpload.tsx           # Upload con validaci√≥n JWT
‚îÇ   ‚îú‚îÄ‚îÄ DataPreview.tsx          # Preview con datos aislados
‚îÇ   ‚îú‚îÄ‚îÄ VariableCategorization.tsx # Categorizaci√≥n autenticada
‚îÇ   ‚îú‚îÄ‚îÄ ValidationReport.jsx     # Reporte con datos propios
‚îÇ   ‚îî‚îÄ‚îÄ ClassificationValuesModal.jsx # Modal de valores
‚îú‚îÄ‚îÄ contexts/
‚îÇ   ‚îî‚îÄ‚îÄ AuthContext.tsx          # üîê Context de autenticaci√≥n JWT
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îî‚îÄ‚îÄ api.ts                   # üîê Cliente HTTP con tokens autom√°ticos
‚îú‚îÄ‚îÄ App.tsx                      # üîê Wrapper de autenticaci√≥n
‚îî‚îÄ‚îÄ index.tsx                    # Punto de entrada
```

### Patr√≥n: Autenticaci√≥n por Contexto

#### AuthContext - Coraz√≥n de la Seguridad Frontend

```typescript
interface AuthContextType {
  // Estado de autenticaci√≥n
  isAuthenticated: boolean;
  accessToken: string | null;
  sessionId: string | null;
  sessionInfo: SessionInfo | null;
  isLoading: boolean;
  
  // Funciones de autenticaci√≥n
  login: (accessKey: string) => Promise<LoginResult>;
  logout: () => void;
  checkSession: () => Promise<boolean>;
}

export const AuthProvider: React.FC = ({ children }) => {
  const [authState, setAuthState] = useState<AuthState>({
    isAuthenticated: false,
    accessToken: null,
    sessionId: null,
    sessionInfo: null
  });

  // üîÑ Validaci√≥n autom√°tica al cargar
  useEffect(() => {
    const initializeAuth = async () => {
      const storedToken = localStorage.getItem('accessToken');
      const storedSessionId = localStorage.getItem('sessionId');
      
      if (storedToken && storedSessionId) {
        const isValid = await validateStoredSession(storedToken);
        if (isValid) {
          setAuthState({
            isAuthenticated: true,
            accessToken: storedToken,
            sessionId: storedSessionId
          });
        } else {
          clearStoredAuth(); // Limpia tokens inv√°lidos
        }
      }
    };
    
    initializeAuth();
  }, []);
};
```

#### Wrapper de Aplicaci√≥n con Autenticaci√≥n

```typescript
// App.tsx - Control de acceso principal
function MainApp() {
  const { isAuthenticated, isLoading } = useAuth();

  // üîÑ Estado de carga
  if (isLoading) {
    return <CircularProgress />; // Spinner mientras valida
  }

  // üîê No autenticado ‚Üí Login
  if (!isAuthenticated) {
    return <Login />; // Pantalla de login institucional
  }

  // ‚úÖ Autenticado ‚Üí Aplicaci√≥n principal
  return <AppContent />; // Validador con datos del usuario
}

function App() {
  return (
    <AuthProvider>  {/* üîê Proveedor de autenticaci√≥n */}
      <MainApp />
    </AuthProvider>
  );
}
```

### Cliente HTTP Seguro (api.ts)

#### Interceptores Autom√°ticos de JWT
```typescript
// üîê Agregar JWT a todas las requests autom√°ticamente
axios.interceptors.request.use((config) => {
  const token = localStorage.getItem('accessToken');
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// üîê Manejo autom√°tico de expiraci√≥n de tokens
axios.interceptors.response.use(
  response => response,
  error => {
    if (error.response?.status === 401) {
      // Token expirado ‚Üí Logout autom√°tico
      localStorage.removeItem('accessToken');
      localStorage.removeItem('sessionId');
      window.location.reload(); // Fuerza reload para mostrar login
    }
    return Promise.reject(error);
  }
);
```

#### M√©todos de API Seguros
```typescript
export class ApiService {
  // Todos los m√©todos autom√°ticamente incluyen JWT
  
  static async uploadFile(file: File): Promise<UploadResponse> {
    // JWT agregado autom√°ticamente por interceptor
    const response = await axios.post('/api/files/upload', formData);
    return response.data;
  }
  
  static async runValidation(sessionId: number): Promise<ValidationResponse> {
    // JWT + validaci√≥n de propiedad en backend
    const response = await axios.post('/api/validation/run', {
      session_id: sessionId
    });
    return response.data;
  }
}
```

---

## üóÑÔ∏è Base de Datos con Aislamiento

### Esquema SQLite Seguro

#### Estructura con session_id en Todas las Tablas

```sql
-- Uploads con aislamiento de sesi√≥n
uploads (
  id INTEGER PRIMARY KEY,
  session_id VARCHAR(64) NOT NULL,  -- üîê Vincula a sesi√≥n de usuario
  filename TEXT,
  file_path TEXT,
  file_size INTEGER,
  expires_at DATETIME,              -- üßπ Para limpieza autom√°tica
  created_at TIMESTAMP
);

-- Sesiones de validaci√≥n con aislamiento
validation_sessions (
  id INTEGER PRIMARY KEY,
  upload_id INTEGER,
  session_id VARCHAR(64) NOT NULL,  -- üîê Vincula a sesi√≥n de usuario
  filename TEXT,
  file_path TEXT,
  categorization TEXT,              -- JSON de categorizaci√≥n
  validation_results TEXT,          -- JSON de resultados
  expires_at DATETIME,              -- üßπ Para limpieza autom√°tica
  created_at TIMESTAMP
);

-- Exportaciones con aislamiento
exports (
  id INTEGER PRIMARY KEY,
  validation_session_id INTEGER,
  session_id VARCHAR(64) NOT NULL,  -- üîê Vincula a sesi√≥n de usuario
  export_type TEXT,
  file_path TEXT,
  expires_at DATETIME,              -- üßπ Para limpieza autom√°tica
  created_at TIMESTAMP
);
```

#### Repository Pattern Seguro

```python
class DatabaseManager:
    # ‚úÖ Todos los m√©todos requieren session_id
    
    def create_upload_record(self, session_id: str, filename: str, ...):
        """Crea registro vinculado a sesi√≥n espec√≠fica"""
        expires_at = datetime.utcnow() + timedelta(hours=24)
        cursor.execute("""
            INSERT INTO uploads (session_id, filename, file_path, expires_at) 
            VALUES (?, ?, ?, ?)
        """, (session_id, filename, file_path, expires_at))
    
    def get_upload_record(self, upload_id: int, session_id: str):
        """Solo retorna si pertenece a la sesi√≥n"""
        cursor.execute("""
            SELECT * FROM uploads 
            WHERE id = ? AND session_id = ?
        """, (upload_id, session_id))
        return cursor.fetchone()
    
    def cleanup_expired_data(self):
        """üßπ Limpieza autom√°tica de datos expirados"""
        cursor.execute("""
            DELETE FROM uploads WHERE expires_at < datetime('now')
            DELETE FROM validation_sessions WHERE expires_at < datetime('now')
            DELETE FROM exports WHERE expires_at < datetime('now')
        """)
```

### Validaci√≥n de Propiedad de Recursos

#### Decorador @require_session_ownership
```python
def require_session_ownership(resource_type: str):
    """Valida que el recurso pertenezca al usuario actual"""
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            current_session_id = get_jwt_identity()
            
            if resource_type == 'upload':
                upload_id = kwargs.get('upload_id')
                upload = db_manager.get_upload_record(upload_id)
                if not upload or upload['session_id'] != current_session_id:
                    return jsonify({
                        'success': False,
                        'error': 'Archivo no encontrado o acceso no autorizado'
                    }), 404
            
            return f(*args, **kwargs)
        return decorated_function
    return decorator

# Uso en endpoints
@bp.route('/<int:upload_id>/parse', methods=['POST'])
@jwt_required()                          # ‚úÖ Token v√°lido
@require_session_ownership('upload')     # ‚úÖ Es del usuario
def parse_file(upload_id):
    # Solo se ejecuta si el archivo pertenece al usuario
    pass
```

---

## üåê APIs Protegidas

### Estructura de Endpoints Seguros

#### Endpoints de Autenticaci√≥n (`/api/auth/`)
```python
@bp.route('/institutional-login', methods=['POST'])
def institutional_login():
    """üîê Login con clave institucional"""
    access_key = request.json.get('access_key')
    
    # Validar clave contra variable de entorno
    if access_key != os.environ.get('INSTITUTIONAL_ACCESS_KEY'):
        return jsonify({
            'success': False,
            'error': 'Clave institucional inv√°lida',
            'user_message': 'La clave ingresada no es correcta'
        }), 401
    
    # Crear sesi√≥n y JWT
    session_id = session_manager.create_session(
        client_ip=request.remote_addr,
        user_agent=request.headers.get('User-Agent')
    )
    
    access_token = create_access_token(identity=session_id)
    
    return jsonify({
        'success': True,
        'access_token': access_token,
        'session_id': session_id
    }), 200

@bp.route('/logout', methods=['POST'])
@jwt_required()
def logout():
    """üîê Logout e invalidaci√≥n de sesi√≥n"""
    current_session_id = get_jwt_identity()
    session_manager.invalidate_session(current_session_id)
    
    return jsonify({'success': True}), 200
```

#### Endpoints de Archivos Protegidos (`/api/files/`)
```python
@bp.route('/upload', methods=['POST'])
@jwt_required()                          # ‚úÖ JWT requerido
def upload_file():
    """üìÅ Upload de archivo con seguridad"""
    current_session_id = get_jwt_identity()
    file = request.files['file']
    
    # üîê Escaneo de seguridad
    security_validator = FileSecurityValidator()
    is_safe, message = security_validator.validate_file_security(file)
    if not is_safe:
        return jsonify({
            'success': False,
            'error': f'Archivo rechazado por seguridad: {message}'
        }), 400
    
    # Guardar vinculado a sesi√≥n
    upload_id = file_service.save_file(file, current_session_id)
    
    return jsonify({
        'success': True,
        'upload_id': upload_id,
        'message': 'Archivo cargado de forma segura'
    }), 201

@bp.route('/<int:upload_id>/parse', methods=['POST'])
@jwt_required()                          # ‚úÖ JWT requerido  
@require_session_ownership('upload')     # ‚úÖ Propiedad validada
def parse_file(upload_id):
    """üìä Parse solo si es del usuario"""
    # Solo se ejecuta si upload_id pertenece al usuario actual
    result = file_service.parse_file(upload_id)
    return jsonify(result), 200
```

#### Endpoints de Validaci√≥n Protegidos (`/api/validation/`)
```python
@bp.route('/run', methods=['POST'])
@jwt_required()                          # ‚úÖ JWT requerido
@require_session_ownership('validation') # ‚úÖ Validaci√≥n de propiedad
def run_validation():
    """‚úÖ Ejecutar validaciones en datos propios"""
    current_session_id = get_jwt_identity()
    session_id = request.json.get('session_id')
    
    # Validar que la validation_session pertenezca al usuario
    validation_session = db.get_validation_session(session_id)
    if validation_session['session_id'] != current_session_id:
        return jsonify({
            'success': False,
            'error': 'Acceso no autorizado a esta sesi√≥n de validaci√≥n'
        }), 403
    
    # Ejecutar validaciones solo en datos del usuario
    engine = ValidationEngine(data, categorization)
    report = engine.generate_comprehensive_report()
    
    return jsonify({
        'success': True,
        'validation_report': report.to_dict()
    }), 200
```

#### Endpoints de Exportaci√≥n Protegidos (`/api/export/`)
```python
@bp.route('/normalized', methods=['POST'])
@jwt_required()                          # ‚úÖ JWT requerido
def export_normalized():
    """üì§ Exportar solo datos del usuario"""
    current_session_id = get_jwt_identity()
    session_id = request.json.get('session_id')
    
    # Validaci√≥n manual de propiedad
    validation_session = db.get_validation_session(session_id)
    if validation_session['session_id'] != current_session_id:
        return jsonify({
            'success': False,
            'error': 'Acceso no autorizado a esta sesi√≥n'
        }), 403
    
    # Exportar datos (solo del usuario)
    normalizer = DataNormalizer()
    excel_buffer = normalizer.export_normalized_data(...)
    
    # Crear registro de exportaci√≥n vinculado a sesi√≥n
    export_id = db.create_export_record(
        validation_session_id=session_id,
        session_id=current_session_id,
        export_type='normalized_xlsx',
        file_path=temp_file_path
    )
    
    return jsonify({
        'success': True,
        'export_id': export_id
    }), 201

@bp.route('/<int:export_id>/download', methods=['GET'])
@jwt_required()                          # ‚úÖ JWT requerido
def download_export(export_id):
    """‚¨áÔ∏è Descargar solo exportaciones propias"""
    current_session_id = get_jwt_identity()
    
    # Validar propiedad del export
    export_record = db.get_export_record(export_id)
    if export_record['session_id'] != current_session_id:
        return jsonify({
            'success': False,
            'error': 'Exportaci√≥n no encontrada o acceso no autorizado'
        }), 404
    
    # Servir archivo solo si es del usuario
    return send_file(export_record['file_path'], as_attachment=True)
```

### Manejo de Errores de Seguridad

#### C√≥digos de Error de Seguridad
```python
# Errores de autenticaci√≥n
'TOKEN_EXPIRED'           # JWT expirado
'INVALID_TOKEN'           # JWT inv√°lido
'TOKEN_REQUIRED'          # JWT faltante
'INVALID_CREDENTIALS'     # Clave institucional incorrecta

# Errores de autorizaci√≥n  
'UNAUTHORIZED_ACCESS'     # Acceso no autorizado a recurso
'SESSION_NOT_FOUND'       # Sesi√≥n no existe
'RESOURCE_NOT_OWNED'      # Recurso no pertenece al usuario
'SESSION_EXPIRED'         # Sesi√≥n caducada

# Errores de seguridad de archivos
'FILE_SECURITY_VIOLATION' # Archivo rechazado por seguridad
'MALICIOUS_CONTENT'       # Contenido malicioso detectado
'UNSUPPORTED_FILE_TYPE'   # Tipo de archivo no permitido
```

#### Respuestas de Error Seguras
```python
# ‚ùå Respuesta insegura (revela informaci√≥n)
return jsonify({
    'error': 'User john@company.com tried to access file owned by mary@company.com'
}), 403

# ‚úÖ Respuesta segura (informaci√≥n m√≠nima)
return jsonify({
    'success': False,
    'error': 'Archivo no encontrado o acceso no autorizado',
    'error_code': 'RESOURCE_NOT_FOUND'
}), 404
```

---

## ‚öôÔ∏è Configuraci√≥n de Seguridad

### Scripts de Setup Autom√°tico

#### setup_development.ps1
```powershell
# üîê Configuraci√≥n de desarrollo seguro
Write-Host "üõ°Ô∏è  Configurando entorno de desarrollo seguro..." -ForegroundColor Cyan

# Generar SECRET_KEY seguro
$SecretKey = [System.Web.Security.Membership]::GeneratePassword(32, 0)

# Generar INSTITUTIONAL_ACCESS_KEY
$AccessKey = Read-Host "Ingrese la clave institucional para desarrollo"

# Crear archivo .env
@"
SECRET_KEY=$SecretKey
INSTITUTIONAL_ACCESS_KEY=$AccessKey
FLASK_ENV=development
"@ | Out-File -FilePath ".env" -Encoding utf8

Write-Host "‚úÖ Configuraci√≥n de desarrollo creada" -ForegroundColor Green
Write-Host "üîë Clave institucional configurada: $AccessKey" -ForegroundColor Yellow
```

#### setup_production.ps1
```powershell
# üîê Configuraci√≥n de producci√≥n segura
Write-Host "üõ°Ô∏è  Configurando entorno de producci√≥n seguro..." -ForegroundColor Red

# Validaciones de producci√≥n
if (-not $env:FRONTEND_URL) {
    Write-Error "‚ùå FRONTEND_URL requerida para producci√≥n"
    exit 1
}

# Generar claves de producci√≥n m√°s seguras
$SecretKey = [System.Web.Security.Membership]::GeneratePassword(64, 8)
$AccessKey = Read-Host "Ingrese la clave institucional de PRODUCCI√ìN" -AsSecureString

# Crear archivo .env de producci√≥n
@"
SECRET_KEY=$SecretKey
INSTITUTIONAL_ACCESS_KEY=$AccessKey
FLASK_ENV=production
FRONTEND_URL=$env:FRONTEND_URL
MAX_CONTENT_LENGTH=52428800
"@ | Out-File -FilePath ".env" -Encoding utf8

Write-Host "‚úÖ Configuraci√≥n de producci√≥n creada" -ForegroundColor Green
Write-Host "‚ö†Ô∏è  IMPORTANTE: Respaldar archivo .env de forma segura" -ForegroundColor Yellow
```

### Variables de Entorno de Seguridad

#### .env File Structure
```env
# üîê CLAVES DE SEGURIDAD (REQUERIDAS)
SECRET_KEY=clave-super-secreta-de-al-menos-32-caracteres-para-jwt
INSTITUTIONAL_ACCESS_KEY=clave-institucional-compartida

# üåç CONFIGURACI√ìN DE ENTORNO
FLASK_ENV=development  # o 'production'

# üåê CONFIGURACI√ìN DE CORS (PRODUCCI√ìN)
FRONTEND_URL=https://tu-dominio.com

# üìÅ CONFIGURACI√ìN DE ARCHIVOS
MAX_CONTENT_LENGTH=52428800  # 50MB en bytes

# üóÑÔ∏è CONFIGURACI√ìN DE BASE DE DATOS (OPCIONAL)
DATABASE_PATH=validador.db
```

#### Validaci√≥n de Configuraci√≥n
```python
def validate_production_config():
    """Validaciones cr√≠ticas antes de iniciar"""
    flask_env = os.environ.get('FLASK_ENV', 'development')
    
    if flask_env == 'production':
        # ‚úÖ Validar claves de seguridad
        secret_key = os.environ.get('SECRET_KEY', '')
        institutional_key = os.environ.get('INSTITUTIONAL_ACCESS_KEY', '')
        
        # ‚ùå Prevenir claves de desarrollo en producci√≥n
        if secret_key in ['dev-secret-key', 'dev-secret-key-change-in-production']:
            raise ValueError(
                "CRITICAL SECURITY ERROR: Using development SECRET_KEY in production!"
            )
        
        # ‚úÖ Validar longitud m√≠nima
        if len(secret_key) < 32:
            raise ValueError(
                "CRITICAL SECURITY ERROR: SECRET_KEY must be at least 32 characters long"
            )
        
        if len(institutional_key) < 16:
            raise ValueError(
                "CRITICAL SECURITY ERROR: INSTITUTIONAL_ACCESS_KEY too short"
            )
        
        # ‚úÖ Validar CORS de producci√≥n
        frontend_url = os.environ.get('FRONTEND_URL')
        if not frontend_url:
            raise ValueError(
                "CRITICAL SECURITY ERROR: FRONTEND_URL must be set for production CORS"
            )

# Ejecutar validaci√≥n al iniciar la app
validate_production_config()
```

### CORS Espec√≠fico por Entorno

#### Configuraci√≥n de CORS Segura
```python
def configure_cors(app, flask_env):
    """Configuraci√≥n de CORS espec√≠fica por entorno"""
    
    if flask_env == 'production':
        # üîí Producci√≥n: CORS estricto a dominio espec√≠fico
        production_url = os.environ.get('FRONTEND_URL')
        if not production_url:
            raise ValueError("FRONTEND_URL must be set in production")
        
        CORS(app, origins=[production_url], supports_credentials=True)
        print(f"üîí Production CORS configured for: {production_url}")
        
    else:
        # üöß Desarrollo: CORS a localhost √∫nicamente
        development_origins = [
            "http://localhost:3000",
            "http://127.0.0.1:3000",
        ]
        CORS(app, origins=development_origins, supports_credentials=True)
        print(f"üöß Development CORS configured for: {development_origins}")
```

---

## üîß C√≥mo Hacer Cambios Seguros

### ‚úÖ Cambios Seguros Recomendados

#### 1. Agregar Nuevas Validaciones (Seguro)
**D√≥nde:** `backend/app/services/validation_engine.py`
```python
def _validate_new_security_rule(self):
    """Nueva validaci√≥n con datos aislados"""
    # ‚úÖ Los datos ya est√°n filtrados por sesi√≥n
    # ‚úÖ No hay riesgo de acceso cross-user
    return {
        'is_valid': True/False,
        'errors': [...],
        'statistics': {...}
    }

def generate_comprehensive_report(self):
    return ValidationReport(
        # ... validaciones existentes
        new_validation=self._validate_new_security_rule()
    )
```
**Impacto de Seguridad:** ‚úÖ Ninguno - Datos ya aislados

#### 2. Modificar UI de Login (Seguro)
**D√≥nde:** `frontend/src/components/Login.tsx`
```typescript
// ‚úÖ Cambios seguros en Login
const Login = () => {
  // Modificar estilos, campos adicionales, validaciones client-side
  // Cambiar textos, idiomas, iconos
  // Agregar campos de informaci√≥n adicional
  
  // ‚ö†Ô∏è NO cambiar la l√≥gica de autenticaci√≥n sin revisar backend
  const handleSubmit = async (e) => {
    // ... l√≥gica existente de autenticaci√≥n
  };
};
```
**Impacto de Seguridad:** ‚úÖ M√≠nimo - Solo afecta presentaci√≥n

#### 3. Agregar Nuevos Tipos de Exportaci√≥n (Seguro)
**D√≥nde:** `backend/app/routes/export.py` + frontend
```python
@bp.route('/new-export-type', methods=['POST'])
@jwt_required()                          # ‚úÖ Reutilizar decoradores de seguridad
def export_new_format():
    current_session_id = get_jwt_identity()
    
    # ‚úÖ Validar propiedad de la sesi√≥n (patr√≥n existente)
    validation_session = db.get_validation_session(session_id)
    if validation_session['session_id'] != current_session_id:
        return jsonify({'error': 'Unauthorized'}), 403
    
    # L√≥gica de exportaci√≥n espec√≠fica
    # ...
```
**Impacto de Seguridad:** ‚úÖ Controlado - Usa patrones seguros existentes

### ‚ö†Ô∏è Cambios Que Requieren Cuidado

#### 1. Modificar Duraci√≥n de Sesiones
**D√≥nde:** `backend/app/models/session_model.py`
```python
# ‚ö†Ô∏è Cambio que afecta seguridad
session_duration_hours = 24  # Cambiar con cuidado

# Consideraciones:
# - Menos tiempo = M√°s seguro pero menos usable
# - M√°s tiempo = Menos seguro pero m√°s usable
# - Cambio afecta limpieza autom√°tica
```
**Riesgos:** Sesiones muy largas = mayor exposici√≥n de riesgo
**C√≥mo Hacerlo Seguro:**
1. Evaluar necesidades de usabilidad vs seguridad
2. Configurar como variable de entorno
3. Testing exhaustivo de limpieza autom√°tica
4. Documentar cambio en logs de seguridad

#### 2. Modificar Validaci√≥n de Archivos
**D√≥nde:** `backend/app/services/file_security.py`
```python
def validate_file_security(self, file):
    # ‚ö†Ô∏è Cambios en validaci√≥n de seguridad
    allowed_extensions = ['.xlsx', '.csv', '.xls']  # Modificar con cuidado
    max_size = 16 * 1024 * 1024  # 16MB - cambiar evaluando riesgo
```
**Riesgos:** 
- Permitir extensiones inseguras
- Archivos muy grandes consumen memoria
- Bypass de validaciones de seguridad

**C√≥mo Hacerlo Seguro:**
1. Research de seguridad para nuevas extensiones
2. Testing con archivos maliciosos
3. Monitoreo de memoria y performance
4. Validaci√≥n adicional para nuevos tipos

#### 3. Cambiar Algoritmo de Generaci√≥n de Session IDs
**D√≥nde:** `backend/app/models/session_model.py`
```python
# ‚ö†Ô∏è CR√çTICO - Cambio en generaci√≥n de IDs
def create_session(self):
    # ACTUAL (seguro)
    session_id = f"sess_{secrets.token_urlsafe(32)}"
    
    # ‚ùå NUNCA usar generaci√≥n d√©bil
    # session_id = f"sess_{random.randint(1000, 9999)}"  # INSEGURO!
    
    # ‚úÖ Alternativas seguras
    # session_id = f"sess_{uuid.uuid4()}"
    # session_id = f"sess_{secrets.token_hex(32)}"
```
**Riesgos Cr√≠ticos:**
- Session hijacking
- Predicci√≥n de session IDs
- Escalamiento de privilegios

### üö´ Cambios NO Recomendados / Peligrosos

#### 1. ‚ùå Deshabilitar Autenticaci√≥n JWT
```python
# ‚ùå NUNCA hacer esto
@bp.route('/upload', methods=['POST'])
# @jwt_required()  # ‚Üê NO comentar/eliminar
def upload_file():
    # Sin JWT = acceso an√≥nimo = CR√çTICO
    pass
```
**Por Qu√© NO:** Rompe completamente la seguridad de la aplicaci√≥n

#### 2. ‚ùå Eliminar Validaci√≥n de Propiedad de Recursos
```python
# ‚ùå NUNCA hacer esto
@bp.route('/<int:upload_id>/parse', methods=['POST'])
@jwt_required()
# @require_session_ownership('upload')  # ‚Üê NO comentar/eliminar  
def parse_file(upload_id):
    # Sin validaci√≥n de propiedad = acceso cross-user = CR√çTICO
    pass
```
**Por Qu√© NO:** Usuarios podr√≠an acceder a datos de otros usuarios

#### 3. ‚ùå Hardcodear Claves de Seguridad
```python
# ‚ùå NUNCA hacer esto
app.config['SECRET_KEY'] = 'clave-facil-123'  # INSEGURO
INSTITUTIONAL_ACCESS_KEY = 'admin123'         # INSEGURO

# ‚úÖ SIEMPRE usar variables de entorno
app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY')
```
**Por Qu√© NO:** Claves expuestas en c√≥digo = compromiso total

#### 4. ‚ùå Deshabilitar HTTPS en Producci√≥n
```python
# ‚ùå NUNCA hacer esto en producci√≥n
if flask_env == 'production':
    # Strict-Transport-Security deshabilitado = INSEGURO
    pass
```
**Por Qu√© NO:** Tokens JWT viajando en texto plano = man-in-the-middle

### üîç Checklist de Cambios Seguros

Antes de implementar cualquier cambio, verificar:

#### ‚úÖ Checklist de Seguridad
- [ ] ¬øEl cambio mantiene autenticaci√≥n JWT?
- [ ] ¬øEl cambio mantiene aislamiento de datos por sesi√≥n?
- [ ] ¬øEl cambio introduce nuevos endpoints? ‚Üí Agregar `@jwt_required()`
- [ ] ¬øEl cambio maneja datos de usuario? ‚Üí Validar propiedad de recursos
- [ ] ¬øEl cambio modifica validaci√≥n de archivos? ‚Üí Testing de seguridad
- [ ] ¬øEl cambio afecta almacenamiento? ‚Üí Verificar session_id en queries
- [ ] ¬øEl cambio modifica configuraci√≥n? ‚Üí Validar en desarrollo Y producci√≥n
- [ ] ¬øEl cambio est√° documentado? ‚Üí Actualizar documentaci√≥n de seguridad

#### üß™ Checklist de Testing
- [ ] Tests unitarios pasan
- [ ] Tests de autenticaci√≥n pasan  
- [ ] Tests de autorizaci√≥n pasan
- [ ] Testing manual del flujo completo
- [ ] Testing con m√∫ltiples usuarios simulados
- [ ] Testing de casos edge de seguridad
- [ ] Validaci√≥n en entorno similar a producci√≥n

---

## üöÄ Deployment y Producci√≥n

### Checklist de Deployment Seguro

#### üîê Preparaci√≥n de Seguridad
- [ ] **Ejecutar `setup_production.ps1`** para generar claves seguras
- [ ] **Validar variables de entorno** est√°n configuradas correctamente
- [ ] **Configurar FRONTEND_URL** espec√≠fica para producci√≥n
- [ ] **Verificar SECRET_KEY** tiene al menos 64 caracteres
- [ ] **Confirmar INSTITUTIONAL_ACCESS_KEY** es suficientemente complejo
- [ ] **Testing de configuraci√≥n** con `validate_production_config()`

#### üåê Configuraci√≥n de Servidor
- [ ] **HTTPS configurado** con certificado v√°lido
- [ ] **Firewall configurado** para puertos espec√≠ficos √∫nicamente
- [ ] **Base de datos SQLite** con permisos restrictivos (600)
- [ ] **Directorio de uploads** fuera del webroot
- [ ] **Logs de seguridad** configurados y monitoreados
- [ ] **Backups autom√°ticos** de base de datos configurados

#### üìä Monitoreo de Seguridad
```python
# M√©tricas a monitorear en producci√≥n
metrics_to_monitor = {
    'failed_login_attempts': 'Intentos de login fallidos por IP',
    'session_creation_rate': 'Rate de creaci√≥n de sesiones',
    'suspicious_requests': 'Requests a endpoints inexistentes',
    'file_upload_failures': 'Uploads rechazados por seguridad',
    'jwt_token_errors': 'Errores de tokens JWT',
    'session_expiry_rate': 'Rate de expiraci√≥n de sesiones'
}
```

### Configuraci√≥n de Producci√≥n

#### Web Server Configuration (Nginx)
```nginx
server {
    listen 443 ssl http2;
    server_name tu-dominio.com;
    
    # üîê SSL/TLS Configuration
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/private.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    
    # üõ°Ô∏è Security Headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains";
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options DENY;
    add_header X-XSS-Protection "1; mode=block";
    
    # üìÅ File Upload Limits
    client_max_body_size 50M;
    
    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # üö´ Block access to sensitive files
    location ~ /\\.env {
        deny all;
        return 404;
    }
}
```

#### Sistema de Limpieza en Producci√≥n
```python
# crontab para limpieza adicional en producci√≥n
# 0 2 * * * /path/to/cleanup_script.py  # Limpieza diaria a las 2 AM

def production_cleanup():
    """Limpieza m√°s agresiva para producci√≥n"""
    
    # Limpiar sesiones expiradas
    session_manager.cleanup_expired_sessions()
    
    # Limpiar archivos hu√©rfanos
    cleanup_orphaned_files()
    
    # Limpiar logs antiguos (>30 d√≠as)
    cleanup_old_logs(days=30)
    
    # Vacuum base de datos SQLite
    db_manager.vacuum_database()
    
    # Log de limpieza para auditor√≠a
    log_cleanup_stats()
```

### Respuesta a Incidentes de Seguridad

#### üö® Procedimientos de Emergencia

**1. Compromiso de Clave Institucional:**
```bash
# Cambiar inmediatamente en .env
INSTITUTIONAL_ACCESS_KEY=nueva-clave-segura-inmediatamente

# Invalidar todas las sesiones activas
python manage.py invalidate_all_sessions

# Reiniciar servicio
systemctl restart validador-app
```

**2. Actividad Sospechosa Detectada:**
```python
# Script de an√°lisis de logs
def analyze_security_logs():
    suspicious_patterns = [
        'Multiple failed login attempts from same IP',
        'JWT token manipulation attempts',
        'Cross-session data access attempts',
        'Unusual file upload patterns'
    ]
    
    # Generar reporte de seguridad
    generate_security_report(suspicious_patterns)
    
    # Alertar administradores
    alert_security_team()
```

**3. Performance/DoS Attack:**
```python
# Rate limiting de emergencia
from flask_limiter import Limiter

limiter = Limiter(
    app,
    key_func=get_remote_address,
    default_limits=["5 per minute"]  # L√≠mite agresivo
)

@limiter.limit("1 per minute")
@bp.route('/institutional-login', methods=['POST'])
def emergency_rate_limited_login():
    pass
```

---

## üîß Troubleshooting

### Problemas Comunes de Seguridad y Soluciones

#### üîê Problemas de Autenticaci√≥n

**Problema:** "Authorization token required. Please login"
```
Error: Usuario ve pantalla de login repetidamente
Causa: Token JWT inv√°lido, expirado o no enviado
```
**Diagn√≥stico:**
```bash
# Verificar configuraci√≥n
cat backend/.env | grep SECRET_KEY
cat backend/.env | grep INSTITUTIONAL_ACCESS_KEY

# Verificar logs del backend
tail -f backend.log | grep "JWT"
```
**Soluci√≥n:**
1. Verificar que `SECRET_KEY` est√© configurado en `.env`
2. Verificar que `INSTITUTIONAL_ACCESS_KEY` sea correcto
3. Reiniciar backend completamente
4. Limpiar localStorage del navegador: F12 ‚Üí Application ‚Üí Local Storage ‚Üí Clear

---

**Problema:** "CRITICAL SECURITY ERROR: Using development SECRET_KEY in production"
```
Error: Aplicaci√≥n no inicia en producci√≥n
Causa: Usando claves de desarrollo en entorno de producci√≥n
```
**Soluci√≥n:**
```bash
# Ejecutar setup de producci√≥n
.\backend\setup_production.ps1

# O configurar manualmente
SECRET_KEY=$(openssl rand -hex 32)
echo "SECRET_KEY=$SECRET_KEY" > backend/.env
```

#### üóÇÔ∏è Problemas de Aislamiento de Datos

**Problema:** "Archivo no encontrado o acceso no autorizado"
```
Error: Usuario no puede acceder a sus propios archivos
Causa: Problema en validaci√≥n de propiedad de recursos
```
**Diagn√≥stico:**
```python
# Verificar en backend logs
print(f"Current session: {get_jwt_identity()}")
print(f"Upload session: {upload_record['session_id']}")
```
**Soluci√≥n:**
1. Verificar que el usuario est√© usando la misma sesi√≥n
2. Verificar que no haya m√∫ltiples tabs con diferentes sesiones
3. Logout y login para nueva sesi√≥n limpia

---

**Problema:** Usuario ve datos de otros usuarios
```
Error: CR√çTICO - Breach de aislamiento de datos
Causa: Fallo en decoradores @require_session_ownership
```
**Soluci√≥n INMEDIATA:**
1. **Apagar aplicaci√≥n inmediatamente**
2. **Revisar logs** para determinar alcance
3. **Verificar integridad** de decoradores de seguridad
4. **Invalidar todas las sesiones** activas
5. **Contactar usuarios afectados**

#### üìÅ Problemas de Seguridad de Archivos

**Problema:** "Archivo rechazado por seguridad"
```
Error: Uploads leg√≠timos siendo rechazados
Causa: Validaci√≥n de seguridad muy estricta o archivo corrupto
```
**Diagn√≥stico:**
```python
# En file_security.py, agregar logging temporal
def validate_file_security(self, file):
    print(f"File name: {file.filename}")
    print(f"File size: {file.content_length}")
    print(f"Detected MIME: {detected_mime}")
    # ... resto de validaci√≥n
```
**Soluci√≥n:**
1. Verificar formato de archivo (solo .xlsx, .xls, .csv permitidos)
2. Verificar tama√±o (m√°ximo 50MB por defecto)
3. Probar con archivo diferente conocido como v√°lido
4. Si persiste, revisar configuraci√≥n de `python-magic`

---

**Problema:** "python-magic not available - using fallback file type detection"
```
Warning: Detecci√≥n de tipos de archivo degradada
Causa: python-magic no instalado correctamente
```
**Soluci√≥n:**
```bash
# Windows
pip install python-magic-bin

# Linux/Mac  
pip install python-magic
# Tambi√©n instalar libmagic system package

# Verificar instalaci√≥n
python -c "import magic; print('Magic OK')"
```

#### üßπ Problemas de Limpieza Autom√°tica

**Problema:** "Archivos antiguos no se eliminan autom√°ticamente"
```
Error: Acumulaci√≥n de archivos temporales
Causa: Scheduler de limpieza no funcionando
```
**Diagn√≥stico:**
```bash
# Verificar logs del scheduler
grep "Cleanup" backend.log
grep "expired" backend.log

# Verificar manualmente
ls -la backend/uploads/ | wc -l
```
**Soluci√≥n:**
1. Reiniciar aplicaci√≥n para reiniciar scheduler
2. Ejecutar limpieza manual:
```python
from app.utils.cleanup_scheduler import cleanup_expired_data
cleanup_expired_data()
```
3. Verificar permisos de escritura en directorios temporales

#### üåê Problemas de CORS

**Problema:** "CORS policy: Request blocked"
```
Error: Frontend no puede comunicarse con backend
Causa: Configuraci√≥n de CORS incorrecta
```
**Diagn√≥stico:**
```bash
# Verificar configuraci√≥n CORS en logs
grep "CORS configured for" backend.log

# Verificar variable de entorno
echo $FRONTEND_URL
```
**Soluci√≥n:**
```bash
# Desarrollo
# Verificar que backend est√© en puerto 5000 y frontend en 3000

# Producci√≥n  
# Configurar FRONTEND_URL correctamente
export FRONTEND_URL=https://tu-dominio.com
```

#### üíæ Problemas de Base de Datos

**Problema:** "database is locked"
```
Error: Operaciones de base de datos fallan
Causa: M√∫ltiples conexiones o conexi√≥n no cerrada correctamente
```
**Soluci√≥n:**
```bash
# Reiniciar aplicaci√≥n
pkill -f "python.*run.py"
python backend/run.py

# Si persiste, verificar archivo de BD
lsof backend/validador.db

# √öltimo recurso: recrear BD (PIERDE DATOS)
rm backend/validador.db
python backend/run.py  # Recrear√° autom√°ticamente
```

### üîç Logs de Debugging de Seguridad

#### Activar Logging Detallado
```python
# En app/__init__.py, agregar logging de seguridad
import logging
logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('security.log'),
        logging.StreamHandler()
    ]
)

# Logs espec√≠ficos de seguridad
security_logger = logging.getLogger('security')

# En endpoints cr√≠ticos
@bp.route('/institutional-login', methods=['POST'])
def institutional_login():
    security_logger.info(f"Login attempt from IP: {request.remote_addr}")
    # ... resto del c√≥digo
```

#### Interpretar Logs de Seguridad
```bash
# Buscar intentos de login fallidos
grep "Invalid institutional key" security.log

# Buscar accesos no autorizados
grep "UNAUTHORIZED_ACCESS" security.log  

# Buscar actividad de limpieza
grep "Cleanup completed" security.log

# Buscar errores JWT
grep "JWT" security.log | grep "ERROR"

# Monitorear requests sospechosas  
grep "SUSPICIOUS REQUEST" security.log
```

### üìû Contacto de Emergencia

#### üö® Si Detectas Vulnerabilidad de Seguridad Cr√≠tica

1. **INMEDIATO:** Apagar aplicaci√≥n (`Ctrl+C` en terminal)
2. **INMEDIATO:** Documentar el issue exacto y pasos para reproducir
3. **INMEDIATO:** Verificar si datos fueron comprometidos
4. **R√ÅPIDO:** Revisar logs para determinar alcance del problema
5. **R√ÅPIDO:** Planificar correcci√≥n y comunicaci√≥n a usuarios
6. **SEGUIMIENTO:** Implementar fix, testing, y deployment seguro

#### üìã Template de Reporte de Seguridad
```markdown
## üö® REPORTE DE SEGURIDAD CR√çTICA

### Informaci√≥n B√°sica
- **Fecha:** [fecha-hora]
- **Versi√≥n:** 2.0 (Sistema Seguro)  
- **Entorno:** [desarrollo/producci√≥n]
- **Reportado por:** [nombre]

### Descripci√≥n del Problema
[Descripci√≥n detallada del problema de seguridad]

### Pasos para Reproducir
1. [Paso 1]
2. [Paso 2] 
3. [Resultado observado]

### Impacto de Seguridad
- [ ] Exposici√≥n de datos de usuarios
- [ ] Bypass de autenticaci√≥n
- [ ] Escalaci√≥n de privilegios  
- [ ] Acceso cross-user
- [ ] Otro: [especificar]

### Acciones Tomadas
- [ ] Aplicaci√≥n apagada inmediatamente
- [ ] Logs preservados  
- [ ] Usuarios notificados
- [ ] Fix implementado
- [ ] Testing de regresi√≥n completado

### Prevenci√≥n Futura
[Medidas para prevenir recurrencia]
```

---

**üéØ Esta gu√≠a cubre la implementaci√≥n de seguridad completa del Validador de Instrumentos v2.0.**

*Mantener este documento actualizado con cada cambio de seguridad para garantizar operaciones seguras.*